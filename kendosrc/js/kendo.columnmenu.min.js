("function"==typeof define&&define.amd?define:function(e,n){return n()})(["./kendo.popup.min","./kendo.filtermenu.min","./kendo.menu.min"],function(){(function(e,n){function s(n){return e.trim(n).replace(/&nbsp;/gi,"")}var t=window.kendo,i=t.ui,o=e.proxy,l=e.extend,r=e.grep,a=e.map,u=e.inArray,c="k-state-selected",d="asc",p="desc",f="change",m="init",k="kendoPopup",h="kendoFilterMenu",w="kendoMenu",_=".kendoColumnMenu",b=/(\[|\]|\$|\.|\:|\+)/g,v=i.Widget,g=v.extend({init:function(n,s){var i,l=this;v.fn.init.call(l,n,s),n=l.element,s=l.options,l.owner=s.owner,l.dataSource=s.dataSource,l.field=n.attr(t.attr("field")),i=n.find(".k-header-column-menu"),i[0]||(i=n.prepend('<a class="k-header-column-menu" href="#"><span class="k-icon k-i-arrowhead-s"/></a>').find(".k-header-column-menu")),l.link=i.attr("tabindex",-1).on("click"+_,o(l._click,l)),l.wrapper=e('<div class="k-column-menu"/>')},_init:function(){var e=this,n=e.options;e.wrapper.html(t.template(C)({ns:t.ns,messages:n.messages,sortable:n.sortable,filterable:n.filterable,columns:e._ownerColumns(),showColumns:n.columns})),e.popup=e.wrapper[k]({anchor:e.link,open:o(e._open,e),activate:o(e._activate,e),close:e.options.closeCallback}).data(k),e._menu(),e._sort(),e._columns(),e._filter(),e.trigger(m,{field:e.field,container:e.wrapper})},events:[m],options:{name:"ColumnMenu",messages:{sortAscending:"Sort Ascending",sortDescending:"Sort Descending",filter:"Filter",columns:"Columns"},columns:!0,sortable:!0,filterable:!0},destroy:function(){var e=this;v.fn.destroy.call(e),e.filterMenu&&e.filterMenu.destroy(),e.dataSource.unbind("refresh",e._refreshHandler),e.options.columns&&(e.owner.unbind("columnShow",e._updateColumnsMenuHandler),e.owner.unbind("columnHide",e._updateColumnsMenuHandler)),e.menu&&(e.menu.element.off(_),e.menu.destroy()),e.wrapper.off(_),e.popup&&e.popup.destroy(),e.link.off(_)},close:function(){this.menu.close(),this.popup.close(),this.popup.element.off("keydown"+_)},_click:function(e){e.preventDefault(),e.stopPropagation(),this.popup||this._init(),this.popup.toggle()},_open:function(){var n=this;e(".k-column-menu").not(n.wrapper).each(function(){e(this).data(k).close()}),n.popup.element.on("keydown"+_,function(e){e.keyCode==t.keys.ESC&&n.close()})},_activate:function(){this.menu.element.focus()},_ownerColumns:function(){var e=this.owner.columns,n=r(e,function(e){var n=!0,t=s(e.title||"");return(e.menu===!1||!e.field&&!t.length)&&(n=!1),n});return a(n,function(n){return{field:n.field||n.title,title:n.title||n.field,hidden:n.hidden,index:u(n,e)}})},_menu:function(){this.menu=this.wrapper.children()[w]({orientation:"vertical",closeOnClick:!1}).data(w)},_sort:function(){var n=this;n.options.sortable&&(n.refresh(),n._refreshHandler=o(n.refresh,n),n.dataSource.bind(f,n._refreshHandler),n.menu.element.on("click"+_,".k-sort-asc, .k-sort-desc",function(){var s=e(this),t=s.hasClass("k-sort-asc")?d:p;s.parent().find(".k-sort-"+(t==d?p:d)).removeClass(c),n._sortDataSource(s,t),n.close()}))},_sortDataSource:function(e,s){var t,i,o=this,l=o.options.sortable,r=o.dataSource,a=r.sort()||[];if(e.hasClass(c)&&l&&l.allowUnsort!==!1?(e.removeClass(c),s=n):e.addClass(c),l===!0||"single"===l.mode)a=[{field:o.field,dir:s}];else{for(t=0,i=a.length;i>t;t++)if(a[t].field===o.field){a.splice(t,1);break}a.push({field:o.field,dir:s})}r.sort(a)},_columns:function(){var n=this;n.options.columns&&(n._updateColumnsMenu(),n._updateColumnsMenuHandler=o(n._updateColumnsMenu,n),n.owner.bind(["columnHide","columnShow"],n._updateColumnsMenuHandler),n.menu.bind("select",function(s){var i,o,l,a,c=e(s.item),d=n.owner.columns;c.parent().closest("li.k-columns-item")[0]&&(i=c.find(":checkbox"),i.attr("disabled")||(a=i.attr(t.attr("field")),l=r(d,function(e){return e.field==a||e.title==a})[0],o=u(l,d),l.hidden===!0?n.owner.showColumn(o):n.owner.hideColumn(o)))}))},_updateColumnsMenu:function(){var e="["+t.attr("field")+"=",n=this._ownerColumns(),s=a(n,function(n){return e+'"'+n.field.replace(b,"\\$1")+'"]'}).join(","),i=r(n,function(e){return!e.hidden}),o=a(i,function(n){return e+'"'+n.field.replace(b,"\\$1")+'"]'}).join(",");this.wrapper.find(s).attr("checked",!1),this.wrapper.find(o).attr("checked",!0).attr("disabled",1==i.length)},_filter:function(){var e=this,n=e.options;n.filterable!==!1&&(e.filterMenu=e.wrapper.find(".k-filterable")[h](l(!0,{},{appendToElement:!0,dataSource:n.dataSource,values:n.values,field:e.field},n.filterable)).data(h))},refresh:function(){var e,n,s,t=this,i=t.options.dataSource.sort()||[],o=t.field;for(t.wrapper.find(".k-sort-asc, .k-sort-desc").removeClass(c),n=0,s=i.length;s>n;n++)e=i[n],o==e.field&&t.wrapper.find(".k-sort-"+e.dir).addClass(c)}}),C='<ul>#if(sortable){#<li class="k-item k-sort-asc"><span class="k-link"><span class="k-sprite k-i-sort-asc"></span>${messages.sortAscending}</span></li><li class="k-item k-sort-desc"><span class="k-link"><span class="k-sprite k-i-sort-desc"></span>${messages.sortDescending}</span></li>#if(showColumns || filterable){#<li class="k-separator"></li>#}##}##if(showColumns){#<li class="k-item k-columns-item"><span class="k-link"><span class="k-sprite k-i-columns"></span>${messages.columns}</span><ul>#for (var col in columns) {#<li><input type="checkbox" data-#=ns#field="#=columns[col].field#" data-#=ns#index="#=columns[col].index#"/>#=columns[col].title#</li>#}#</ul></li>#if(filterable){#<li class="k-separator"></li>#}##}##if(filterable){#<li class="k-item k-filter-item"><span class="k-link"><span class="k-sprite k-filter"></span>${messages.filter}</span><ul><li><div class="k-filterable"></div></li></ul></li>#}#</ul>';i.plugin(g)})(window.kendo.jQuery)});